name: Deploy Backend to VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"

      - name: ğŸ“¦ Install dependencies
        run: |
          yarn install --frozen-lockfile
          # Jika kamu punya script build, aktifkan baris di bawah:
          # yarn build

      - name: ğŸ—œï¸ Archive project files
        run: |
          tar --exclude='./node_modules' \
          --exclude='./.git' \
          --exclude='./.github' \
          -czf backend.tar.gz ./

      - name: ğŸšš Upload build to VPS (with progress)
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avz --progress
          path: ./backend.tar.gz
          remote_path: /root/backend.tar.gz
          remote_host: ${{ secrets.SERVER_IP }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ğŸš€ Starting backend deployment..."
            cd /root/top-up-game-be

            echo "ğŸ“¦ Extracting new build..."
            rm -rf old || true
            mv src old || true

            tar -xzf ~/backend.tar.gz -C .
            rm ~/backend.tar.gz

            echo "ğŸ“¦ Installing production dependencies..."
            yarn install --production --frozen-lockfile

            echo "ğŸ” Restarting PM2 process..."
            pm2 restart be-topup || pm2 start server.js --name be-topup
            pm2 save

            echo "ğŸ”„ Reloading Nginx..."
            nginx -t && systemctl reload nginx

            echo "âœ… Backend deployed successfully!"
